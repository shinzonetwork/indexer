name: transaction
steps:
  - name: filter_raw_fields
    type: filter
    config:
      fields:
        - hash
        - blockHash
        - blockNumber
        - from
        - to
        - gas
        - gasPrice
        - input
        - nonce
        - value
        - type
        - chainId
        - v
        - r
        - s
        - block_id
        - transactionIndex
        - yParity
        - maxFeePerGas
        - maxPriorityFeePerGas
        - accessList
        - indexedAt
        - network
        - status

  - name: normalize_addresses
    type: normalize
    config:
      fields:
        - hash
        - blockHash
        - from
        - to
      case: lower

  - name: normalize_value
    type: normalize
    config:
      fields:
        - value
      format: string
      transform: |
        function transform(value) {
          if (!value) return "0";
          if (typeof value === "string") return value;
          if (typeof value === "object") {
            if (value.value) {
              return value.value.toString();
            }
            if (value.hex) {
              return value.hex;
            }
            return JSON.stringify(value);
          }
          return value.toString();
        }

  - name: normalize_numbers
    type: normalize
    config:
      fields:
        - blockNumber
        - gas
        - gasPrice
        - nonce
        - type
        - chainId
        - v
        - maxFeePerGas
        - maxPriorityFeePerGas
      format: string

  - name: map_fields
    type: enrich
    config:
      fields:
        hash: "hash"
        blockHash: "blockHash"
        blockNumber: "blockNumber"
        from: "from"
        to: "to"
        value: "value"
        gas: "gas"
        gasPrice: "gasPrice"
        input: "input"
        nonce: "nonce"
        transactionIndex: "transactionIndex"
        r: "r"
        s: "s"
        v: "v"
        type: "type"
        yParity: "yParity"
        chainId: "chainId"
        maxFeePerGas: "maxFeePerGas"
        maxPriorityFeePerGas: "maxPriorityFeePerGas"
        accessList: "accessList"
        indexedAt: "indexedAt"
        network: "network"
        status: "status"
        block_id: "block_id"

  - name: validate_fields
    type: validate
    config:
      required:
        - hash
        - blockHash
        - blockNumber
        - from
        - to
        - value
        - gas
        - gasPrice
        - input
        - nonce
        - transactionIndex
        - r
        - s
        - v
        - type
        - chainId
        - block_id

  - name: prepare_fields
    type: enrich
    config:
      fields:
        network:
          value: "${env.NETWORK_NAME}"
        indexedAt:
          value: "${now()}"
        accessList:
          value: ""
        yParity:
          value: ""
        maxFeePerGas:
          value: ""
        maxPriorityFeePerGas:
          value: ""
        status:
          value: true

  - name: store_transaction
    type: enrich
    config:
      query: |
        mutation CreateTransaction($hash: String!, $blockHash: String!, $blockNumber: String!, $from: String!, $to: String!, $value: String!, $gas: String!, $gasPrice: String!, $input: String!, $nonce: String!, $transactionIndex: String!, $r: String!, $s: String!, $v: String!, $type: String!, $chainId: String!, $block_id: String!, $yParity: String, $maxFeePerGas: String, $maxPriorityFeePerGas: String, $accessList: String, $indexedAt: String, $network: String, $status: Boolean) {
          create_Transaction(input: {
            hash: $hash
            blockHash: $blockHash
            blockNumber: $blockNumber
            from: $from
            to: $to
            value: $value
            gas: $gas
            gasPrice: $gasPrice
            input: $input
            nonce: $nonce
            transactionIndex: $transactionIndex
            r: $r
            s: $s
            v: $v
            type: $type
            chainId: $chainId
            block_id: $block_id
            yParity: $yParity
            maxFeePerGas: $maxFeePerGas
            maxPriorityFeePerGas: $maxPriorityFeePerGas
            accessList: $accessList
            indexedAt: $indexedAt
            network: $network
            status: $status
          }) {
            _docID
            hash
          }
        }
